---
description: Preset management domain conventions
globs: tauri/src/presets/**/*.rs, src/lib/presets/**/*.ts, src/components/presets/**/*.tsx
alwaysApply: false
---

# Preset Domain Conventions

## Data Storage

**Pedal state:** Store as JSON blob in `parameters` column

```rust
pub struct Preset {
    pub id: String,
    pub parameters: serde_json::Value,  // MicrocosmState, GenLossState, etc.
}
```

**Validation:** Handle on deserialization, graceful fallback for schema changes

## Bank Tracking

**Principle:** App tracks only what it writes

- Bank assignments are best-effort tracking
- Manual pedal saves make tracking stale (expected)
- No synchronization from pedal to app (MIDI read not supported)

## MIDI Bank Save Sequence

**Microcosm working sequence (verified):**
1. Load factory effect (PC 0-43)
2. Apply CC parameters (Activity, Mix, etc.)
3. Send Copy (CC 45) - enters paste mode → **WAIT 1 second**
4. Send PC to user bank (PC 44-59) - selects target slot → **WAIT 1 second**
5. Send Save (CC 46) - pastes copied preset → **WAIT 1 second**

**Key insights:**
- PC after CC 45 doesn't exit paste mode, it selects the target slot
- 1 second delays are REQUIRED between copy/navigate/save steps
- This replicates manual "Hold → Turn → Hold" workflow
- PC numbers are 0-indexed: Bank 1A (docs say PC 45) = MIDI PC 44

**Timing:**
- 100ms after loading factory effect
- 50ms after applying CCs
- **1000ms** between copy/navigate/save (critical!)

## Frontend Organization

Mirrors backend structure:

```
src/lib/presets/       # API wrappers (like lib/midi/)
src/components/presets/ # UI components (like components/pedals/)
src/hooks/presets/     # React hooks (like hooks/pedals/)
```

## Naming Conventions

- `PresetLibrary` - Aggregate root (backend)
- `PresetRepository` - Persistence layer
- `BankTracker` - Domain service
- `usePresetLibrary` - React hook (frontend)

## Bank Number Ranges

**Microcosm user banks:** PC 45-60 (16 slots)
- Bank 1: 45-48 (A-D) - Red
- Bank 2: 49-52 (A-D) - Yellow
- Bank 3: 53-56 (A-D) - Green
- Bank 4: 57-60 (A-D) - Blue
